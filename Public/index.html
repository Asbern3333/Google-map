<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Business Data Extractor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    form {
      background: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 320px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 15px;
    }
    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      background-color: #0078d7;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #005fa3;
    }
    #status {
      text-align: center;
      margin-top: 15px;
      color: #333;
    }
  </style>
</head>
<body>
  <form id="searchForm">
    <h2>Google Map Extractor</h2>
    <input type="text" id="query" placeholder="Search (e.g. plumbers)" required>
      <!-- State select -->
      <select id="state"
               style="
                      width: 100%;
                      padding: 12px;
                      border: none;
                      border-radius: 8px;
                      background: linear-gradient(90deg, #b8d8f1, #b6dcf1);
                      color: #000000;
                      font-size: 16px;
                      font-weight: bold;
                      cursor: pointer;
                      transition: all 0.3s ease;
                      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    " required >
        <option value="">Select a State</option>
        <option value="AL">Alabama</option>
        <option value="AK">Alaska</option>
        <option value="AZ">Arizona</option>
        <option value="AR">Arkansas</option>
        <option value="CA">California</option>
        <option value="CO">Colorado</option>
        <option value="CT">Connecticut</option>
        <option value="DE">Delaware</option>
        <option value="FL">Florida</option>
        <option value="GA">Georgia</option>
        <option value="HI">Hawaii</option>
        <option value="ID">Idaho</option>
        <option value="IL">Illinois</option>
        <option value="IN">Indiana</option>
        <option value="IA">Iowa</option>
        <option value="KS">Kansas</option>
        <option value="KY">Kentucky</option>
        <option value="LA">Louisiana</option>
        <option value="ME">Maine</option>
        <option value="MD">Maryland</option>
        <option value="MA">Massachusetts</option>
        <option value="MI">Michigan</option>
        <option value="MN">Minnesota</option>
        <option value="MS">Mississippi</option>
        <option value="MO">Missouri</option>
        <option value="MT">Montana</option>
        <option value="NE">Nebraska</option>
        <option value="NV">Nevada</option>
        <option value="NH">New Hampshire</option>
        <option value="NJ">New Jersey</option>
        <option value="NM">New Mexico</option>
        <option value="NY">New York</option>
        <option value="NC">North Carolina</option>
        <option value="ND">North Dakota</option>
        <option value="OH">Ohio</option>
        <option value="OK">Oklahoma</option>
        <option value="OR">Oregon</option>
        <option value="PA">Pennsylvania</option>
        <option value="RI">Rhode Island</option>
        <option value="SC">South Carolina</option>
        <option value="SD">South Dakota</option>
        <option value="TN">Tennessee</option>
        <option value="TX">Texas</option>
        <option value="UT">Utah</option>
        <option value="VT">Vermont</option>
        <option value="VA">Virginia</option>
        <option value="WA">Washington</option>
        <option value="WV">West Virginia</option>
        <option value="WI">Wisconsin</option>
        <option value="WY">Wyoming</option>
      </select>
  <input type="text" id="city" placeholder="city (optional)">
  <input
  type="number"
  id="zipcode"
  placeholder="zipcode (optional)"
  minlength="5"
  maxlength="5"
  oninput="this.value = this.value.slice(0, 5);"
/>
  <button type="submit">Export CSV</button>
  <button type="button" id="stopBtn" style="background-color: red;">
    Stop
  </button>
  <div id="status"></div>
</form>




  <script>
    let controller = null;

document.getElementById('searchForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  controller?.abort();            // cancel old if exists
  controller = new AbortController();
  const signal = controller.signal;

  const query = document.getElementById('query').value.trim();
  const state = document.getElementById('state').value;
  const city = document.getElementById('city').value.trim();
  const status = document.getElementById('status');
  const zip = document.getElementById('zipcode').value;

  if (zip.length !== 5) {
      console.log("Zip must be 5 digits");
  }
  if (!query || !state) {
    status.textContent = 'Search and State are required.';
    return;
  }

  status.textContent = 'Processing... please wait.';

  const body = zip?{state, query, zipcode:[zip]}: city ? { state, query, city: [city] } : { state, query };

  try {
    const response = await fetch('http://localhost:3000/export', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      signal
    });

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${query}_${state}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    status.textContent = 'Download complete.';
  } catch (err) {
    if (err.name === 'AbortError') {
      status.textContent = 'Stopped.';
    } else {
      status.textContent = 'Server not reachable.';
    }
  }
});

// stop button
document.getElementById("stopBtn").addEventListener("click", () => {
  controller?.abort();                       // stop fetch
  fetch("http://localhost:3000/cancel", {    // ask backend to stop
    method: "POST"
  });
});
    /*document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const query = document.getElementById('query').value.trim();
      const state = document.getElementById('state').value  ;
      const city = document.getElementById('city').value.trim();
      const status = document.getElementById('status');
      
      if (!query || !state) {
        status.textContent = 'Search and State are required.';
        return;
      }

      status.textContent = 'Processing... please wait.';

      const body = city ? { state, query, city: [city] } : { state, query };

      try {
        const response = await fetch('http://localhost:3000/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (!response.ok) {
          status.textContent = 'Error fetching data.';
          return;
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${query}_${state}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        status.textContent = 'Download complete.';
      } catch (err) {
        status.textContent = 'Server not reachable.';
      }
    });*/
  </script>
</body>
</html>
